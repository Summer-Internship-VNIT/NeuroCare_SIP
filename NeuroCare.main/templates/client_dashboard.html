{% extends 'layout.html' %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if data|length > 0 %}
<div class="dashboard-container">

  <!-- Patient Info -->
  <div class="card info-card">
    <h2>Patient Dashboard</h2>
    <p><strong>Patient ID:</strong> {{ data[0]['Patient_ID'] }}</p>
    <p><strong>Sample Code:</strong> {{ data[0]['Sample Code'] }}</p>
    <!-- <p><strong>Last Test Date:</strong> {{ data[-1]['Date'] }}</p> -->
    <p><strong>Last Test Date:</strong>
    {% if data[-1]['Date'] %}
      {{ data[-1]['Date'] }}
    {% else %}
      N/A
    {% endif %}
    </p>
  </div>

  <!-- Stat Cards -->
  <div class="card-grid">
    <div class="card stat-card"><h4>TLC</h4><p>{{ data[-1]['TLC'] }}</p></div>
    <div class="card stat-card"><h4>Lymphocytes%</h4><p>{{ data[-1]['L%'] }}%</p></div>
    <div class="card stat-card"><h4>Polymorphs%</h4><p>{{ data[-1]['P%'] }}%</p></div>
    <div class="card stat-card"><h4>Sugar</h4><p>{{ data[-1]['Sugar'] }} mg/dL</p></div>
    <div class="card stat-card"><h4>Protein</h4><p>{{ data[-1]['Protein'] }} mg/dL</p></div>
  </div>

  <!-- Prediction Result Block -->
  {% if prediction %}
  <div class="card-grid" style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
    <div class="card stat-card" style="flex: 1 1 200px; text-align: center;">
      <h4>Prediction Result:</h4>
      <p style="color: '{% if prediction and prediction.condition == 'Abnormal' %}red{% elif prediction %}green{% else %}black{% endif %}';">
        {{ prediction.condition if prediction else 'N/A' }}
      </p>
    </div>
    <div class="card stat-card" style="flex: 1 1 200px; text-align: center;">
      <h4>TBM Evaluation Score:</h4>
      <p>{{ prediction.tbm_score if prediction else 'N/A' }}</p>
    </div>
    <div class="card stat-card" style="flex: 1 1 300px; text-align: center;">
      <h4>Interpretation:</h4>
      <p>{{ prediction.interpretation if prediction else 'N/A' }}</p>
    </div>
  </div>
  {% endif %}

  <!-- Charts Section -->
  <div class="charts-container">
    <div class="card chart-card">
      <h3>TLC Over Time</h3>
      <canvas id="trendChart"></canvas>
    </div>
    <div class="card chart-card">
      <h3>CSF Cell Composition</h3>
      <canvas id="lpPieChart"></canvas>
    </div>
    <div class="card chart-card">
      <h3>Sugar & Protein Over Time</h3>
      <canvas id="sugarProteinChart"></canvas>
    </div>
  </div>
  
  <!-- Report Section -->
  <div style="text-align: center; margin-top: 30px;">
  <a href="{{ url_for('report') }}"
     style="padding: 10px 20px; background-color: #6c63ff; color: white; text-decoration: none; border-radius: 5px;">
    View Full Report
  </a>
  </div>

  <!-- Historical Records Table -->
  <div class="card table-card">
    <h3>Historical Records</h3>
    <input type="text" id="searchInput" placeholder="Search by Sample Code...">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Sample Code</th>
            <th>TLC</th>
            <th>L%</th>
            <th>P%</th>
            <th>Sugar</th>
            <th>Protein</th>
            <th>Diagnosis</th>
            <th>TBM Score</th>
          </tr>
        </thead>
        <tbody id="historyTable">
          {% for row in data %}
          <tr>
            <td>{{ row['Date'] }}</td>
            <td>{{ row['Sample Code'] }}</td>
            <td>{{ row['TLC'] }}</td>
            <td>{{ row['L%'] }}</td>
            <td>{{ row['P%'] }}</td>
            <td>{{ row['Sugar'] }}</td>
            <td>{{ row['Protein'] }}</td>
            <td style="color: '{% if row['Diagnosis'] == 'Abnormal' %}red{% elif row['Diagnosis'] %}green{% else %}black{% endif %}';">
              {{ row['Diagnosis'] if row['Diagnosis'] else 'N/A' }}
            </td>
            <td>{{ row.get('TBM Score', 'N/A') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- JavaScript Chart Section -->
<script>
  const chartData = JSON.parse('{{ data | tojson | safe }}');

  // Format date to "20 Jun 2025"
  const formatDate = dateStr => {
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    }).format(date);
  };

  // TLC Trend Chart
  new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels: chartData.map(r => formatDate(r['Date'])),
      datasets: [{
        label: 'TLC',
        data: chartData.map(r => r['TLC']),
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'TLC Trend Over Time' }
      }
    }
  });


  // L% vs P% Pie Chart â€” uses latest record
  const latestRecord = chartData[chartData.length - 1];
  new Chart(document.getElementById('lpPieChart'), {
    type: 'pie',
    data: {
      labels: ['Lymphocytes (L%)', 'Polymorphs (P%)'],
      datasets: [{
        data: [latestRecord['L%'], latestRecord['P%']],
        backgroundColor: ['#36A2EB', '#FF6384'],
        hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Lymphocytes vs Polymorphs' }
      }
    }
  });

  // Sugar & Protein Trend
  new Chart(document.getElementById('sugarProteinChart'), {
    type: 'line',
    data: {
      labels: chartData.map(r => formatDate(r['Date'])),
      datasets: [
        {
          label: 'Sugar',
          data: chartData.map(r => r['Sugar']),
          borderColor: '#f39c12',
          backgroundColor: 'rgba(243, 156, 18, 0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Protein',
          data: chartData.map(r => r['Protein']),
          borderColor: '#8e44ad',
          backgroundColor: 'rgba(142, 68, 173, 0.2)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Sugar & Protein Trend' }
      }
    }
  });


  // Sample Code Search Filter
  document.getElementById("searchInput").addEventListener("input", function () {
    const value = this.value.toLowerCase();
    document.querySelectorAll("#historyTable tr").forEach(row => {
      const sampleCode = row.children[1].textContent.toLowerCase();
      row.style.display = sampleCode.includes(value) ? "" : "none";
    });
  });
</script>

{% else %}
<div class="dashboard-container">
  <div class="card info-card">
    <h3>Welcome!</h3>
    <p>No CSF records found yet.</p>
    <p>Please <a href="{{ url_for('data_entry') }}">enter lab data</a> to see your dashboard.</p>
  </div>
</div>
{% endif %}

{% endblock %}
